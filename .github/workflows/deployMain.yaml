name: Docker Deploy Main

on:
  push:
    branches: [ "main" ]

jobs:
  build_and_tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from .csproj
        id: extract_version
        run: |
          VERSION=$(grep -oPm1 "(?<=<Version>)[^<]+" TestProject/TestProject/TestProject.csproj)
          if [ -n "$VERSION" ]; then
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          else
            echo "Failed to extract version"
            exit 1
          fi

      - name: Configure Git
        if: env.VERSION
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Check if tag exists and delete if present
        if: env.VERSION
        id: delete_tag
        run: |
          if git rev-parse "v${{ env.VERSION }}" >/dev/null 2>&1; then
            git tag -d "v${{ env.VERSION }}"
            git push --delete origin "v${{ env.VERSION }}"
            echo "Deleted existing tag v${{ env.VERSION }}"
          fi

      - name: Tag the commit
        if: env.VERSION
        run: |
          git tag -a "v${{ env.VERSION }}" -m "Version ${{ env.VERSION }}"
          
      - name: Force-push tags to origin
        if: env.VERSION
        run: |
          git push origin "v${{ env.VERSION }}"

      - name: Docker login
        if: env.VERSION
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin https://apiubu02.m2mservices.com
          
      - name: Build and Push Docker Image
        if: env.VERSION
        run: |
          docker build -t apiubu02.m2mservices.com/test_projects:testproject_latest -t apiubu02.m2mservices.com/test_projects:testproject_${{ env.VERSION }} -f TestProject/TestProject/Dockerfile .
          docker push apiubu02.m2mservices.com/test_projects:testproject_latest
          docker push apiubu02.m2mservices.com/test_projects:testproject_${{ env.VERSION }}
